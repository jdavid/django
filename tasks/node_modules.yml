#
# npm install
#
# Input   : django_root (optional)
#

- name: "npm yes or not"
  stat:
    path: "{{ django_root }}/package.json"
  register: "st"

- name: "Install packages based on package.json"
  command:
    chdir: "{{ django_root }}"
    cmd: "npm {% if django_combined.debug %}install{% else %}ci{% endif %}"
  when: "st.stat.exists == True"

- name: "npm run build"
  command:
    chdir: "{{ django_root }}"
    cmd: "npm run build --if-present"
  when: "st.stat.exists == True and django_combined.debug == False"


#
# TODO Try the npm module once Ansible 2.10 is released.
# Today it doesn't work because it doesn't check for devDependencies in the
# output of "npm list --json --long".
# https://github.com/ansible-collections/community.general/blob/main/plugins/modules/packaging/language/npm.py#L190
#
# npm:
#   path: "{{ django_root }}"
#   production: "{{ not django_combined.debug }}"
